name: Create Release APK (signed with debug key)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to build"
        required: true
        default: "main"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository (selected branch)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper

      - name: Make Gradle wrapper executable
        run: chmod +x gradlew

      - name: Build release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: Create debug keystore
        run: |
          keytool -genkeypair \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -keystore debug.keystore \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"

      - name: Find and sign all APKs with debug key
        run: |
          mkdir -p artifacts

          # Find all APKs recursively
          APK_LIST=$(find . -type f -name "*.apk")

          if [ -z "$APK_LIST" ]; then
            echo "No APK files found!"
            exit 1
          fi

          echo "Found APK files:"
          echo "$APK_LIST"

          for apk in $APK_LIST; do
            base=$(basename "$apk" .apk)
            signed_apk="artifacts/${base}-signed-debug.apk"

            echo "Signing $apk â†’ $signed_apk"

            jarsigner \
              -keystore debug.keystore \
              -storepass android \
              -keypass android \
              -signedjar "$signed_apk" \
              "$apk" \
              androiddebugkey
          done

          ls -l artifacts

      - name: Upload signed APK(s)
        uses: actions/upload-artifact@v4
        with:
          name: signed-debug-apks
          path: artifacts/*.apk
